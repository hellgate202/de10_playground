Building linux for DE10 board

# U-Boot

U-Boot is used from the official U-Boot repository 

https://github.com/u-boot/u-boot.git

Fork used 

https://github.com/hellgate202/u-boot

I've checked out latest tag v2021.04-rc3 and then swtiched to my own playground branch

Changes:

Added FPGA configuration during U-Boot from soc_system.rbf file

In include/config_distro_bootcmd.h

```
"distro_bootcmd=echo Programming FPGA; "               \
  "if fatload mmc 0:1 0x2000000 soc_system.rbf; then " \
    "echo --- Programming FPGA ---; "                  \
    "fpga load 0 0x2000000 0x700000; "                 \
  "fi; "                                               \
```

is added to:

```
BOOT_TARGET_DEVICES(BOOTENV_DEV)             \
\
"distro_bootcmd=" BOOTENV_SET_SCSI_NEED_INIT \
  BOOTENV_SET_NVME_NEED_INIT                 \
  BOOTENV_SET_IDE_NEED_INIT                  \
  BOOTENV_SET_VIRTIO_NEED_INIT               \
  "for target in ${boot_targets}; do "       \
    "run bootcmd_${target}; "                \
  "done\0"

#ifndef CONFIG_BOOTCOMMAND
#define CONFIG_BOOTCOMMAND "run distro_bootcmd"
#endif
```
Added default MAC generated by gen_eth_addr

```
make -C tools gen_eth_addr
tools/gen_eth_addr
```

Generated MAC is added to include/configs/socfpga_common.h

```
#ifndef CONFIG_EXTRA_ENV_SETTINGS
#define CONFIG_EXTRA_ENV_SETTINGS                             \
        "fdtfile=" CONFIG_DEFAULT_FDT_FILE "\0"               \
        "bootm_size=0xa000000\0"                              \
        "kernel_addr_r="__stringify(CONFIG_SYS_LOAD_ADDR)"\0" \
        "fdt_addr_r=0x02000000\0"                             \
        "scriptaddr=0x02100000\0"                             \
        "pxefile_addr_r=0x02200000\0"                         \
        "ramdisk_addr_r=0x02300000\0"                         \
        "socfpga_legacy_reset_compat=1\0"                     \
        BOOTENV

#endif
```

Setting compiler

```
wget https://releases.linaro.org/components/toolchain/binaries/latest-7/arm-linux-gnueabihf/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf.tar.xz
tar -xvf gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf.tar.xz 
export CROSS_COMPILE=`pwd`/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-
```

To build U-boot

```
make ARCH=arm socfpga_de10_nano_defconfig
make ARCH=arm menuconfig
make ARCH=arm -j 4
```

Second command is needed only if you want to modify U-boot

# Kernel

Using altera linux repository for kernel

https://github.com/altera-opensource/linux-socfpga

Fork used

https://github.com/hellgate202/linux-socfpga

Current latest branch was used socfpga-5.10

To build kernel

```
make ARCH=arm socfpga_defconfig
make ARCH=arm menuconfig
make ARCH=arm LOCALVERSION=zImage -j 4
```

In order to support flashing FPGA from linux check all boxes in Overlayfs

# RootFS

Create rootfs directory and setup deboostrap and qemu

Install these packages if they are not present
```
sudo apt install debootstrap qemu-user-static
```

Prepare debian buster RootFS
```
mkdir rootfs
sudo debootstrap --arch=armhf --foreign buster rootfs
sudo cp /usr/bin/qemu-arm-static rootfs/usr/bin/
sudo chroot rootfs /usr/bin/qemu-arm-static /bin/bash -i
/debootstrap/debootstrap --second-stage
```

Configuring RootFS and installing some packages

```
apt install vim
apt install locales
dpkg-reconfigure locales
apt install openssh-server
apt install haveged
apt install net-tools build-essential device-tree-compiler
systemctl enable serial-getty@ttyS0.service
```

Set up new password

```
passwd
```

Add this to `/etc/fstab`
```
none		/tmp	tmpfs	defaults,noatime,mode=1777	0	0
/dev/mmcblk0p2	/	ext4	defaults	0	1 
```

Add this to `/etc/network/interfaces`
```
auto lo eth0
allow-hotplug eth0
iface lo inet loopback
iface eth0 inet dhcp
```

Add this to `/etc/apt/sources.list`
```
deb http://deb.debian.org/debian/ buster main contrib non-free
deb-src http://deb.debian.org/debian/ buster main contrib non-free
deb http://deb.debian.org/debian/ buster-updates main contrib non-free
deb-src http://deb.debian.org/debian/ buster-updates main contrib non-free
deb http://deb.debian.org/debian-security/ buster/updates main contrib non-free
deb-src http://deb.debian.org/debian-security/ buster/updates main contrib non-free
```

Change and uncomment this line in `/etc/ssh/sshd_config`
```
PermitRootLogin yes
```
